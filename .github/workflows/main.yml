name: gitleaks
on:
  pull_request:
  push:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *" # Run once a day at 4 AM UTC

jobs:
  scan:
    name: gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: Run Gitleaks Secret Scan
        id: gitleaks_scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: Send Discord Notification
    run: |
    curl -H "Content-Type: application/json" \
      -X POST \
      -d '{
        "username": "Gitleaks",
        "avatar_url": "https://avatars.githubusercontent.com/u/54240749?s=200&v=4",
        "embeds": [{
          "title": "ðŸš¨ Gitleaks Scan Detected Secrets!",
          "description": "ðŸ›‘ **Secret Detected!**\nðŸ”— **[View Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})**",
          "color": 16711680,
          "fields": [
            { "name": "Repository", "value": "${{ github.repository }}", "inline": true },
            { "name": "Branch", "value": "${{ github.ref_name }}", "inline": true },
            { "name": "Commit", "value": "[`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})", "inline": false },
            { "name": "Action Required", "value": "ðŸš¨ **Rotate this secret ASAP if it is real.**\nðŸ›‘ **If false positive, add this to `.gitleaksignore`**", "inline": false }
          ]
        }]
      }' "$DISCORD_WEBHOOK_URL"
  env:
    DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
