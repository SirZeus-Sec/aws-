name: gitleaks
on:
  pull_request:
  push:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *" # Run once a day at 4 AM UTC

jobs:
  scan:
    name: gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks Secret Scan
        id: gitleaks_scan
        continue-on-error: true
        run: |
          gitleaks detect --redact --report=gitleaks-report.json || echo "Gitleaks scan failed"

      - name: Check if secrets were found
        id: check_secrets
        run: |
          if grep -q '"leaks":\[\]' gitleaks-report.json; then
            echo "No secrets found"
            echo "SECRETS_FOUND=false" >> $GITHUB_ENV
          else
            echo "ðŸš¨ Secrets detected by Gitleaks!"
            echo "SECRETS_FOUND=true" >> $GITHUB_ENV
          fi

      - name: Send Discord Notification if Leaks Detected
        if: env.SECRETS_FOUND == 'true'
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "username": "Gitleaks",
            "avatar_url": "https://avatars.githubusercontent.com/u/60353350?s=200&v=4",
            "content": "ðŸš¨ **Secret Detected in Repository!**\nðŸ”— [View Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\nðŸ›‘ **Take Immediate Action!**"
          }' ${{ secrets.DISCORD_WEBHOOK }}
