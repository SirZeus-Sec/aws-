name: gitleaks
on:
  pull_request:
  push:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *" # Run once a day at 4 AM UTC

jobs:
  scan:
    name: gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks Secret Scan
        id: gitleaks_scan
        continue-on-error: true
        run: |
          gitleaks detect --redact --report=gitleaks-report.json || echo "Gitleaks scan failed"

      - name: Check if secrets were found
        id: check_secrets
        run: |
          if grep -q '"leaks":\[\]' gitleaks-report.json; then
            echo "No secrets found"
            echo "SECRETS_FOUND=false" >> $GITHUB_ENV
          else
            echo "ðŸš¨ Secrets detected by Gitleaks!"
            echo "SECRETS_FOUND=true" >> $GITHUB_ENV
          fi

      - name: Extract Secret Details
        if: env.SECRETS_FOUND == 'true'
        run: |
          LEAKS=$(jq -r '.leaks[] | "ðŸ›‘ **Secret Detected!**\nFile: \(.file)\nRule ID: \(.ruleID)\nCommit: \(.commit)\n\n**Action Required:**\n- Rotate this secret if it is a true positive.\n- If false positive, add this to `.gitleaksignore`:\n```\n\(.commit):\(.file):\(.ruleID):\(.line)\n```"' gitleaks-report.json)
          echo "PR_COMMENT<<EOF" >> $GITHUB_ENV
          echo "$LEAKS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment on PR
        if: env.SECRETS_FOUND == 'true' && github.event_name == 'pull_request'
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ðŸš¨ **Gitleaks Scan Detected Secrets!**  
            ðŸ”— [View Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})  
            ${{ env.PR_COMMENT }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
